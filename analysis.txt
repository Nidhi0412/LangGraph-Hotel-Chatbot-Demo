# Analysis: Integrating a New Real API (e.g., Insights) into LangGraph-based Chatbot

## 1. High-Level Steps for Integrating a New API

### A. Add a New Intent
- **File:** langgraph_new.py
- **Change:** Add a new intent (e.g., INSIGHTS) to the Intent enum and update intent classification logic to recognize relevant queries.

### B. Implement the API Wrapper
- **File:** Innalytics_api/Insights_new.py (or wherever your API logic lives)
- **Change:** Write an async function (e.g., get_insights_for_langgraph) that:
  - Accepts parameters (hotel_code, user_id, category, etc.)
  - Calls the real API (or your business logic)
  - Returns structured results (insights, metadata, errors)

### C. Add an Agent Node for the API
- **File:** langgraph_new.py
- **Change:** Implement an agent node (e.g., insights_agent_node) that:
  - Checks if the intent is present
  - Extracts parameters from the state/metadata
  - Calls your API wrapper
  - Returns the result in the expected format

### D. Update the Workflow/Graph
- **File:** langgraph_new.py
- **Change:** Add the new agent node to the LangGraph workflow, update routing/priority, and ensure it's called when the intent is detected.

### E. Update the API Layer
- **File:** fastapi_chatbot.py
- **Change:** Ensure the FastAPI endpoints:
  - Pass required metadata (hotel_code, user_id, etc.) to the workflow
  - Extract and return insights data in the API response
  - Handle and display errors

---

## 2. Detailed List of Code Changes

### A. In langgraph_new.py
1. **Intent Enum**
   - Add INSIGHTS to the Intent enum.
2. **Intent Classification**
   - Add keywords for insights in the rule-based and LLM-based classifiers.
3. **Agent Node**
   - Implement insights_agent_node to call the API wrapper and format the result.
4. **Add Node to Workflow**
   - Add the node to the graph and update routing/priority.
5. **Import the API Wrapper**
   - Import get_insights_for_langgraph from the API module.

### B. In Innalytics_api/Insights_new.py
1. **API Wrapper Function**
   - Implement get_insights_for_langgraph as an async function.
2. **Bypass UI Logic**
   - Ensure this function does not trigger any UI and is backend-safe.

### C. In fastapi_chatbot.py
1. **Update Request Model**
   - Add hotel_code and user_id fields to the request model.
2. **Pass Metadata**
   - Ensure endpoints pass hotel_code and user_id in the metadata.
3. **Extract and Return Insights**
   - Extract insights data from the result and include it in the API response.
4. **Error Handling**
   - Add error handling for insights-specific errors and return structured error messages.

---

## 3. What to Take Note of for Future API Integrations
- **Parameter Passing:** Ensure all required parameters are passed from frontend to backend to the API wrapper.
- **Separation of Concerns:** API wrapper should be independent of UI logic.
- **Error Handling:** Add custom exceptions and propagate errors up to the API response.
- **Response Structure:** Standardize agent node return formats.
- **Testing:** Test with valid and invalid parameters for robust error handling.
- **Extensibility:** Design agent nodes and API wrappers for easy future expansion.

---

## 4. Summary Table
| Change Area         | File(s)                        | What to Change/Implement                                  |
|---------------------|-------------------------------|-----------------------------------------------------------|
| Intent Enum         | langgraph_new.py               | Add new intent                                            |
| Intent Classifier   | langgraph_new.py               | Add keywords/rules for new intent                         |
| Agent Node          | langgraph_new.py               | Implement node to call new API                            |
| API Wrapper         | Innalytics_api/Insights_new.py | Async function to call/process real API                   |
| Workflow/Graph      | langgraph_new.py               | Add node, update routing/priority                         |
| API Layer           | fastapi_chatbot.py             | Pass params, extract/return results, handle errors        |
| Error Handling      | Both                           | Add custom exceptions, propagate errors                   |
| Testing             | All                            | Test with real and mock data                              |

---

## 5. How Easy/Hard Is It?
- **Easy** if your API is stateless, returns JSON, and you follow the above structure.
- **Harder** if your API requires complex authentication, session management, or has side effects.
- **Most important:** Keep your API wrapper logic clean and decoupled from UI/frontend code.

---

**This analysis provides a reusable checklist and summary for integrating new APIs into your LangGraph-based chatbot system.** 